---
创建时间: 2023-03-14T18:15
更新时间: 2023-11-23T11:47
---
一个类的总体加载过程包括：加载、连接、初始化、使用、卸载

这里不讨论类加载器和具体的加载的内存区域，后面文章专门研究

连接包括：验证、准备、解析三个过程

![img](1657359218727-3fabf650-4bc8-45c0-9b19-28d2fa9a2722.jpeg)

## 加载过程

首先通过类的全限定名，获取这个类的二进制流，然后将静态数据结构转化为运行时数据结构，也就是一个静态文件加载到内存中，最后生成一个类信息在方法区入口的`Class`对象

注意事项：

1. 要注意获取二进制流常见的从jar包，war包里面获取
2. 可以通过调整类加载器来改变获取二进制流的方式，这里不讨论
3. 数组不通过类加载器创建，而是Java虚拟机直接创建
4. 加载过程和连接过程是同步进行的，而不是加载完成才开始连接

## 连接过程

连接过程包括：验证、准备、解析三个过程

1. 验证过程：验证主要是验证文件格式、元数据、字节码、符号引用，主要就是验证类格式是否正确符合JVM要求，是否能够正确执行，字节码文件中，所有的方法和变量引用其它东西都是使用的符号引用，而不是直接对应内存地址，所以具体调用的时候，需要将符号引用转换为内存地址(直接引用)
2. 准备阶段：为类变量分配内存并设置初始值，只是类变量，也就是静态变量，1.7以前是随着类存放在永久代(方法区实现)中，1.7之后静态变量和字符串常量池(也就是Java常量)和Class对象存放在堆中，同时准备阶段只会设置初始值，除非使用final关键字，才会在这个阶段设置具体的值，final常量保存，如果是成员常量，1.7及以前永久代实现方法区中的运行时常量池，1.8开始存放在元空间实现的方法区中运行时常量池，如果是局部常量，那肯定随方法存储在栈中
3. 解析阶段：将符号引用解析替换为直接引用，得到类或者字段、方法在内存中的指针或者偏移量

## 初始化过程

`Javac`编译之后会自动生成`<clinit>()`初始化方法，这个方法是带锁线程安全的

只有主动去使用类，才会调用初始化方法，包含以下的5中情况，会初始化类调用初始化方法：

1. 使用类：在new 创建实例、访问静态变量、给静态变量赋值、调用静态方法时
2. 使用反射：在使用反射调用`Class.forname("...")`、`newInstance()`等方法会初始化
3. 初始化子类，会先初始化父类
4. 会首先初始化主类，然后调用`main`方法
5. 接口的默认方法，也就是接口中有`default`方法，那么在调用接口的实现类之前，这个接口会先进行初始化

## 卸载过程

卸载一个类就是这个类被垃圾回收GC回收掉了，要卸载一个类需要有三个条件：

1. 这个类的所有实例对象在堆中被GC回收
2. 这个类没有任何地方引用，注意是类引用，也就是具体的对象引用这个类元数据，没有任何实例去创建这个类对象
3. 这个类的类加载器的实例被GC回收

而在JVM，自带的类加载器实例是不会回收的，而被回收的一般是用户自定义类加载器，JDK自带的`BootstrapClassLoader`、`ExtClassLoader`、`AppClassLoader`肯定不会回收