---
创建时间: 2023-09-05T14:02
更新时间: 2023-11-23T11:47
---
## 新理解
```js
var sum = (function () {
  var total = 0
  return function (x) {
    total += x
    return total
  }
})()

console.log(sum(1))

console.log(sum(2))

console.log(sum(3))
```
实质上是给我们想要的函数封装套上一个统一的外部环境，然后我们的sum函数(也就是内部return的部分)，可以使用共享的外部变量了，这是闭包的意义，这样可以做很多事情，比如单例模式，把instance放在函数外部环境共享。
## 什么是闭包
MDN定义：闭包是一个函数以及其捆绑的周边环境状态（**词法环境**）的引用的组合。换而言之，闭包让开发者可以从内部函数访问外部函数的作用域。在 JavaScript 中，闭包会随着函数的创建而被同时创建。
简单来说：
	闭包 = 函数 + 函数外部词法环境
也可以说：
	函数都是闭包，因为函数都拥有一个隐藏属性 `[[Scope]]` (别称 `[[Environment]]`)，里面保存了函数外部词法环境的引用，所以函数总是可以访问外部词法环境的变量，即使函数在它所处的词法作用域之外被调用。
	
 > 注意： `new Function()` 创建的函数不是闭包，其创建的词法环境，是全局环境，可以通过 new Function的特性，来具体了解。
 
 从上面的内容，对闭包有个大概印象，其是函数和函数所在环境结合在一起，形成一个封闭的包，封闭的环境。
## 词法环境 
JavaScript 中，每执行一段可执行代码（函数、代码块{...}以及全局代码）都会创建一个与之关联的**对象**，被称为词法环境。词法环境就是俗称的作用域和作用域链的内部实现机制。
下面通过下面3个步骤来进行理解:
### Step1.全局词法环境
每执行一段可执行代码创建的词法环境对象包含两个部分：
1. 环境记录 —— 一个存储所有局部变量作为其属性（包括一些其他信息，例如 `this` 的值）的对象。
2. 对外部词法环境的引用，与外部代码相关联。

举例说明：
```js
let foo = 'hello'
```
当声明一个变量foo，其实是给环境记录这个内部对象添加了一个属性foo，获取和修改foo其实都是在操作这个属性。
```js
let foo = 'hello'
function bar() {
  console.log('world')
}
```
现在，又声明了一个函数，声明时就在全局环境中创建了这个函数，也就是在全局词法环境的环境记录添加了属性。
上面两段代码的外部词法环境的引用都是null，因为它们都在全局词法环境中，已经是最外部了。
> 注意：
>“词法环境”是一个规范对象（specification object）：它只存在于 [语言规范](https://tc39.es/ecma262/#sec-lexical-environments) 的“理论”层面，用于描述事物是如何工作的。我们无法在代码中获取该对象并直接对其进行操作。
>但 JavaScript 引擎同样可以优化它，比如清除未被使用的变量以节省内存和执行其他内部技巧等，但显性行为应该是和上述的无差。

### Step2.内部和外部词法环境
上面的代码，所有代码都发生在全局词法环境中，下面来看看内部和外部词法环境:
```js
let foo = 'hello'
function fn() {
  let bar = 'world'
  console.log(foo)
}
fn()
```
直到执行到最后一行 `fn()` 前，代码都和前面没什么不同，直到调用 `fn()` 时，创建了一个内部词法环境，它和全局词法环境一样，同样包含全局记录和外部词法环境的引用(这里是全局词法环境)
再看看这个：
```js
let foo = 'hello'
function fn() {
  function inner() {}
  inner()
}
fn()
```
当执行inner()时，创建了inner内部词法环境，包含inner的全局记录以及其外部词法环境(fn词法环境)。
总结：
函数在声明时，并未创建这个函数的内部环境，在调用时创建词法环境以及其外部引用对象。
### Step3.查找路径
了解内外环境之后，再看看变量的查找路径，就是从内到外查找，只有内部没有某个变量时，才会向外查找。
```js
let foo = 'hello'
function fn() {
  let foo = 'world'
  inner()
  function inner() {
    let foo = 'javascript'
    console.log(foo) // 输出 javascript
  }
}
fn()
```
![[CleanShot 2024-05-28 at 09.51.06@2x.png]]
JavaScript词法环境，其实就是作用域，内部作用域可以访问外部的作用域里的内容，通常我们写JavaScript代码，这点不用提，大家都会用，实现方法就是每个作用域通过环境记录对象和外部词法引用对象来记录。
## 闭包的作用
了解词法环境之后，再看闭包的定义：闭包 = 函数 + 函数外部词法环境，当创建一个函数之后，正是由于JavaScript词法环境提供的访问外部词法环境的能力，所以形成了闭包。
注意区分这两个东西：
词法环境是JavaScript的一种规范，闭包基于这种规范，才在创建函数的时候，形成一个闭包，拥有在函数内部访问外部的能力。
并不是创建一个内部词法环境就成闭包了，通过块级作用域、模块、类等方式也可以创建内部词法环境，但是只有函数才是闭包，这点要注意。







